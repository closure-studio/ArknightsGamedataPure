name: Auto Deploy to Server
on:
  push:
    branches:
      - main  # ä½ çš„ä¸»è¦åˆ†æ”¯
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Send Deployment Start Notification
      run: |
        COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -n 1 | sed 's/"/\\"/g' | sed "s/'/\\'/g")
        curl --request POST \
          --url ${{ secrets.QQBOT_URL }} \
          --header 'Content-Type: application/json' \
          --data "{
            \"token\": \"${{ secrets.QQBOT_TOKEN }}\",
            \"uid\": ${{ secrets.QQBOT_UID }},
            \"msg\": \"ğŸš€ å¼€å§‹éƒ¨ç½²\\nåˆ†æ”¯: ${{ github.ref_name }}\\nCommit: ${GITHUB_SHA:0:7}\\nä½œè€…: ${{ github.actor }}\\næ¶ˆæ¯: ${COMMIT_MSG}\"
          }"
    
    - name: SSH and Deploy
      id: deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.KEY }}
        port: ${{ secrets.SERVER_SSH_PORT }}
        script: |
          ${{ secrets.SERVER_DEPLOY_COMMAND }}
    
    - name: Send Deployment Success Notification
      if: success()
      run: |
        COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -n 1 | sed 's/"/\\"/g' | sed "s/'/\\'/g")
        curl --request POST \
          --url ${{ secrets.QQBOT_URL }} \
          --header 'Content-Type: application/json' \
          --data "{
            \"token\": \"${{ secrets.QQBOT_TOKEN }}\",
            \"uid\": ${{ secrets.QQBOT_UID }},
            \"msg\": \"âœ… éƒ¨ç½²æˆåŠŸ\\nåˆ†æ”¯: ${{ github.ref_name }}\\nCommit: ${GITHUB_SHA:0:7}\\nä½œè€…: ${{ github.actor }}\\næ¶ˆæ¯: ${COMMIT_MSG}\"
          }"
    
    - name: Send Deployment Failure Notification
      if: failure()
      run: |
        COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -n 1 | sed 's/"/\\"/g' | sed "s/'/\\'/g")
        curl --request POST \
          --url ${{ secrets.QQBOT_URL }} \
          --header 'Content-Type: application/json' \
          --data "{
            \"token\": \"${{ secrets.QQBOT_TOKEN }}\",
            \"uid\": ${{ secrets.QQBOT_UID }},
            \"msg\": \"âŒ éƒ¨ç½²å¤±è´¥\\nåˆ†æ”¯: ${{ github.ref_name }}\\nCommit: ${GITHUB_SHA:0:7}\\nä½œè€…: ${{ github.actor }}\\næ¶ˆæ¯: ${COMMIT_MSG}\\næ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
          }"
